<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UGOKU Lab</title>
    <link href="styles/main.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/cbd15fcef1.js" crossorigin="anonymous"></script>
    
</head>

<body>

    <header class="header">
        <a href="index.html" style="text-decoration: none; color: white;">
            <h1>UGOKU Lab</h1>
        </a>
        <div class="social-icons">
            <a href="https://twitter.com/UGOKU_Lab" target="_blank" title="Twitter"><i class="fa-brands fa-x-twitter"></i>
            <a href="https://github.com/UGOKU-Lab" target="_blank" title="GitHub"><i class="fab fa-github"></i></a>
        </div>
    </header>

    <div class="content-container">
    
        <h1>ジャイロ効果を感じるやつ</h1>
                
        <figure class="video">
            <iframe width="853" height="480" src="https://www.youtube.com/embed/c5LMpY1wxpU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
        </figure>

        <!-- 目次 -->
        <nav class="toc" aria-label="目次">
            <strong>目次</strong>
            <ul>
                <li><a href="#overview">概要</a></li>
                <li><a href="#cad-gen2">CAD</a></li>
                <li><a href="#specs">諸元</a></li>
                <li><a href="#system">システム構成</a></li>
                <li><a href="#rotor">回転部</a></li>
                <li><a href="#housing">筐体</a></li>
                <li><a href="#first-gen">初代</a></li>
            </ul>
            <div class="toc-actions">
                <button type="button" class="toc-btn" data-action="expand">すべて開く</button>
                <button type="button" class="toc-btn" data-action="collapse">すべて閉じる</button>
            </div>
        </nav>

        <div class="project">
            <div class="project-content">
                <div class="buttons-row">
                    <a href="https://github.com/UGOKU-Lab/FeelGyro_M5_ArduinoIDE" target="_blank" class="orange-button">M5 Stick Program</a>
                    <a href="https://github.com/UGOKU-Lab/FeelGyro2_STM_MD_Controller_I2C" target="_blank" class="orange-button">Motor Controller Board Program</a>
                </div>
            </div>
        </div>
        
        <section id="overview">
            <h2>概要</h2>
            <p>
                手にもって動かすと不思議な感覚、地球ゴマとしても遊べる。高速で回転する円盤を手のひらサイズのキューブに収めた、誰でも楽しめる体験型デバイスです。
            </p>
            <p>
                「ジャイロ効果を感じるやつ」はNT東京2023で人気を博した体験をベースに、ブラシレスDCモーターのダイレクトドライブ化で静かで滑らか、さらにコンパクトに。ジャイロ効果体験度は大幅UP。電動地球ゴマとしても楽しめます。
            </p>
        </section>

        <section id="cad-gen2">
            <h2>CAD</h2>
            <div class="embed-center">
                <iframe src="https://outlook187340.autodesk360.com/shares/public/SH286ddQT78850c0d8a41a7502d607ea7472?mode=embed" width="1024" height="768" allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true"  frameborder="0"></iframe>
            </div>
        </section>

        <!-- 諸元（静的表） -->
        <section id="specs">
            <h2>諸元</h2>
            <div class="table-scroll">
                <table class="excel-table">
                    <tbody>
                        <tr>
                            <th>サイズ</th>
                            <td>105 × 105 × 105 mm</td>
                        </tr>
                        <tr>
                            <th>重量</th>
                            <td>2 kg</td>
                        </tr>
                        <tr>
                            <th>フライホイール重量</th>
                            <td>1 kg</td>
                        </tr>
                        <tr>
                            <th>フライホイール慣性モーメント</th>
                            <td>-</td>
                        </tr>
                        <tr>
                            <th>モーター型式・出力</th>
                            <td>maxon EC frameless 45 flat 50W</td>
                        </tr>
                        <tr>
                            <th>消費電力</th>
                            <td>定常 8W / 加速時 40W</td>
                        </tr>
                        <tr>
                            <th>バッテリ容量</th>
                            <td>1200mAh</td>
                        </tr>
                        <tr>
                            <th>稼働時間</th>
                            <td>4h</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- システム構成（常時表示） -->
        <section id="system">
            <h2>システム構成</h2>
            <div class="embed-center">
                <img src="images/GYRO/Gen2_system_diagram.png" alt="システム構成図" style="max-width:100%; height:auto;" />
            </div>
        </section>

        <!-- 回転部（常時表示・部品表） -->
        <section id="rotor" class="structure-item">
            <h2>回転部</h2>
            <p>インホイール・ダイレクトドライブ構造</p>
            <div class="embed-center">
                <img src="images/GYRO/Fly-wheel_unit.png" alt="フライホイールユニット" style="max-width:100%; height:auto;" />
            </div>
            <h3>部品表（フライホイール回転部 全体）</h3>
            <div class="table-scroll js-bom" data-excel="images/GYRO/Gen2_BOM.xlsx" data-table="fly-wheel_unit"></div>
        </section>

        <!-- 筐体（概要常時表示＋詳細折りたたみ） -->
        <section id="housing" class="structure-item">
            <h2>筐体</h2>
                <p>ポリカーボネート製筐体</p>
                <h3>部品表（筐体）</h3>
                <div class="table-scroll js-bom" data-excel="images/GYRO/Gen2_BOM.xlsx" data-table="enclosure"></div>
    </section>

        <section id="first-gen">
            <h2>初代</h2>
            <p>
                高速で回転する円盤を手のひらサイズのキューブに収めた、誰でも楽しめる体験型デバイス。
            </p>
            <figure class="video">
                <video controls src="https://tomohiroaoki.com/wp-content/uploads/2023/05/gyro_small.mp4"></video>
            </figure>
        </section>

        <br>
        <br>

    </div>
    
    <footer>
        <p>&copy; 2025 UGOKU Lab</p>
    </footer>

    <script>
    // TOC: open target section and manage expand/collapse for rotor & housing accordions only
    (function() {
        const toc = document.querySelector('.toc');
        const detailsList = Array.from(document.querySelectorAll('#rotor details.accordion, #housing details.accordion'));

        function openFromHash() {
            const id = decodeURIComponent(location.hash.replace('#',''));
            if (!id) return;
            const target = document.getElementById(id);
            if (target && target.tagName.toLowerCase() === 'details') {
                target.open = true;
                // scroll after open to ensure correct position
                setTimeout(() => target.scrollIntoView({behavior: 'smooth', block: 'start'}), 0);
            } else if (target) {
                const parentDetails = target.closest('details');
                if (parentDetails) parentDetails.open = true;
                setTimeout(() => target.scrollIntoView({behavior: 'smooth', block: 'start'}), 0);
            }
        }

        if (toc) {
            toc.addEventListener('click', (e) => {
                const a = e.target.closest('a');
                if (a && a.getAttribute('href')?.startsWith('#')) {
                    e.preventDefault();
                    const id = a.getAttribute('href').slice(1);
                    const d = document.getElementById(id);
                    if (d && d.tagName.toLowerCase() === 'details') d.open = true;
                    history.pushState(null, '', '#' + id);
                    openFromHash();
                }
                const btn = e.target.closest('.toc-btn');
                if (btn) {
                    const act = btn.dataset.action;
                    detailsList.forEach(d => d.open = (act === 'expand'));
                }
            });
        }
        window.addEventListener('hashchange', openFromHash);
        // open on initial load if hash exists
        if (location.hash) openFromHash();
    })();
    </script>

    <script>
    // Excel BOM loader: fetch and render BOM tables (supports category or named table/sheet)
    (function() {
        const targets = Array.from(document.querySelectorAll('.js-bom[data-excel]'));
        if (!targets.length) return;

        // Load SheetJS dynamically
        function loadSheetJS() {
            return new Promise((resolve, reject) => {
                if (window.XLSX) return resolve();
                const s = document.createElement('script');
                s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
                s.onload = () => resolve();
                s.onerror = () => reject(new Error('SheetJSの読み込みに失敗'));
                document.head.appendChild(s);
            });
        }

        async function fetchWorkbook(url) {
            const res = await fetch(url, { cache: 'no-store' });
            if (!res.ok) throw new Error('BOMファイルの取得に失敗');
            const buf = await res.arrayBuffer();
            return XLSX.read(buf, { type: 'array' });
        }

        function normalize(v) { return (v ?? '').toString().trim(); }

        function detectCategoryKey(rows) {
            const sample = rows[0] || {};
            const keys = Object.keys(sample);
            // 候補: 分類 / カテゴリ / Category
            const candidates = ['分類','カテゴリ','カテゴリー','Category','分類1'];
            return keys.find(k => candidates.some(c => k.toString().includes(c))) || '分類';
        }

        function renderTable(container, rows) {
            if (!rows.length) {
                container.innerHTML = '<div style="padding:8px;color:#666;">該当する部品はありません。</div>';
                return false;
            }
            // Canonical header mapping (variants -> canonical)
            const headerMap = {
                baloon: ['Baloon','Balloon','バルーン','図番','番号'],
                partName: ['Part Name','部品名','品名','品目'],
                unitPrice: ['Unit Price','単価','価格','Price'],
                qty: ['QTY','数量','Qty','数'],
                material: ['Material','材質'],
                plating: ['Plating','表面処理','メッキ']
            };

            // Build a key resolver based on the first row's keys
            const keys = Object.keys(rows[0] || {});
            function resolveKey(cands) {
                return keys.find(k => cands.includes(k)) || null;
            }
            const keyBaloon = resolveKey(headerMap.baloon);
            const keyPartName = resolveKey(headerMap.partName);
            const keyUnitPrice = resolveKey(headerMap.unitPrice);
            const keyQty = resolveKey(headerMap.qty);
            const keyMaterial = resolveKey(headerMap.material);
            const keyPlating = resolveKey(headerMap.plating);

            // Column order as requested
            const headers = [
                { label: 'Baloon', key: keyBaloon },
                { label: 'Part Name', key: keyPartName },
                { label: 'Unit Price', key: keyUnitPrice },
                { label: 'QTY', key: keyQty },
                { label: '全額', key: '__total__' },
                { label: 'Material', key: keyMaterial },
                { label: 'Plating', key: keyPlating }
            ];

            // Filter out columns that couldn't be resolved except total which is computed
            const activeHeaders = headers.filter(h => h.key || h.key === '__total__');

            const thead = '<thead><tr>' + activeHeaders.map(h => `<th>${h.label}</th>`).join('') + '</tr></thead>';
            const tbody = '<tbody>' + rows.map(r => {
                const unitPrice = keyUnitPrice ? parseFloat((r[keyUnitPrice] ?? '').toString().replace(/[^0-9.\-]/g,'')) : NaN;
                const qty = keyQty ? parseFloat((r[keyQty] ?? '').toString().replace(/[^0-9.\-]/g,'')) : NaN;
                const total = (!isNaN(unitPrice) && !isNaN(qty)) ? (unitPrice * qty) : '';
                return '<tr>' + activeHeaders.map(h => {
                    if (h.key === '__total__') return `<td>${total}</td>`;
                    return `<td>${normalize(r[h.key])}</td>`;
                }).join('') + '</tr>';
            }).join('') + '</tbody>';
            container.innerHTML = `<table class="excel-table">${thead}${tbody}</table>`;
            return true;
        }

    // No fallback UI: on failure, leave the container empty

        function rowsFromTarget(wb, el) {
            const tableName = el.getAttribute('data-table');
            try {
                if (tableName && wb) {
                    // Try defined names first (named range)
                    const names = (wb.Workbook && wb.Workbook.Names) || [];
                    const hit = names.find(n => (n.Name || '').toString().trim() === tableName);
                    if (hit && hit.Ref) {
                        const ref = hit.Ref.replace(/\$/g, ''); // remove $ anchors
                        const [sheetName, a1] = ref.split('!');
                        const sheet = wb.Sheets[sheetName.replace(/^'/, '').replace(/'$/, '')] || wb.Sheets[wb.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(sheet, { defval: '', range: a1 });
                        return rows;
                    }
                    // Fallback: if a sheet exists with this name, use it
                    if (wb.Sheets[tableName]) {
                        return XLSX.utils.sheet_to_json(wb.Sheets[tableName], { defval: '' });
                    }
                }
                // Default: first sheet
                const first = wb.Sheets[wb.SheetNames[0]];
                return XLSX.utils.sheet_to_json(first, { defval: '' });
            } catch (e) {
                console.warn('rowsFromTarget error:', e);
                return [];
            }
        }

        (async () => {
            try {
                await loadSheetJS();
                // Resolve absolute URLs and group targets by file to avoid multiple fetches
                const byFile = targets.reduce((m, el) => {
                    const raw = el.getAttribute('data-excel');
                    const abs = new URL(raw, location.href).href; // always resolve relative to current page
                    (m[abs] ||= []).push(el);
                    return m;
                }, {});

                for (const [url, els] of Object.entries(byFile)) {
                    let wb;
                    try {
                        wb = await fetchWorkbook(url);
                    } catch (e) { wb = null; }
                    for (const el of els) {
                        if (!wb) { continue; }
                        let rows = rowsFromTarget(wb, el);
                        const catsAttr = el.getAttribute('data-category');
                        if (catsAttr) {
                            const cats = catsAttr.split('|').map(s => s.trim()).filter(Boolean);
                            const catKey = detectCategoryKey(rows);
                            rows = rows.filter(r => cats.includes(normalize(r[catKey])));
                        }
                        renderTable(el, rows);
                    }
                }
            } catch (err) {
                // Fail silently; fallbacks remain visible
                console.warn(err);
            }
        })();
    })();
    </script>
</body>
</html>
