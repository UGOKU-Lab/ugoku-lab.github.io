<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UGOKU Lab</title>
    <link href="styles/main.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/cbd15fcef1.js" crossorigin="anonymous"></script>
    
</head>

<body>

    <header class="header">
        <a href="index.html" style="text-decoration: none; color: white;">
            <h1>UGOKU Lab</h1>
        </a>
        <div class="social-icons">
            <a href="https://twitter.com/UGOKU_Lab" target="_blank" title="Twitter"><i class="fa-brands fa-x-twitter"></i>
            <a href="https://github.com/UGOKU-Lab" target="_blank" title="GitHub"><i class="fab fa-github"></i></a>
        </div>
    </header>

    <div class="content-container">
    
        <h1>ジャイロ効果を感じるやつ</h1>
                
        <figure class="video">
            <iframe width="853" height="480" src="https://www.youtube.com/embed/c5LMpY1wxpU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
        </figure>

        <!-- 目次 -->
        <nav class="toc" aria-label="目次">
            <strong>目次</strong>
            <ul>
                <li><a href="#overview">概要</a></li>
                <li><a href="#cad-gen2">CAD</a></li>
                <li><a href="#system">システム構成</a></li>
                <li><a href="#rotor">回転部</a></li>
                <li><a href="#housing">筐体</a></li>
                <li><a href="#first-gen">初代</a></li>
            </ul>
            <div class="toc-actions">
                <button type="button" class="toc-btn" data-action="expand">すべて開く</button>
                <button type="button" class="toc-btn" data-action="collapse">すべて閉じる</button>
            </div>
        </nav>

        <div class="project">
            <div class="project-content">
                <div class="buttons-row">
                    <a href="https://github.com/UGOKU-Lab/FeelGyro_M5_ArduinoIDE" target="_blank" class="orange-button">M5 Stick Program</a>
                    <a href="https://github.com/UGOKU-Lab/FeelGyro2_STM_MD_Controller_I2C" target="_blank" class="orange-button">Motor Controller Board Program</a>
                </div>
            </div>
        </div>
        
        <section id="overview">
            <h2>概要</h2>
            <p>
                手にもって動かすと不思議な感覚、地球ゴマとしても遊べる。高速で回転する円盤を手のひらサイズのキューブに収めた、誰でも楽しめる体験型デバイスです。
            </p>
            <p>
                「ジャイロ効果を感じるやつ」はNT東京2023で人気を博した体験をベースに、ブラシレスDCモーターのダイレクトドライブ化で静かで滑らか、さらにコンパクトに。ジャイロ効果体験度は大幅UP。電動地球ゴマとしても楽しめます。
            </p>
        </section>

        <section id="cad-gen2">
            <h2>CAD</h2>
            <div class="embed-center">
                <iframe src="https://outlook187340.autodesk360.com/shares/public/SH286ddQT78850c0d8a41a7502d607ea7472?mode=embed" width="1024" height="768" allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true"  frameborder="0"></iframe>
            </div>
        </section>

        <!-- システム構成（常時表示） -->
        <section id="system">
            <h2>システム構成</h2>
            <div class="embed-center">
                <img src="images/Gen2_system_diagram.png" alt="ジャイロ効果を感じるやつ Gen2 システム構成図" style="max-width:100%; height:auto;" />
            </div>
            <div class="table-scroll">
                <table class="excel-table">
                    <thead>
                        <tr>
                            <th>要素</th>
                            <th>役割</th>
                            <th>代表部品</th>
                            <th>備考</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>回転部</td>
                            <td>ジャイロ効果を生むフライホイールの回転</td>
                            <td>maxon EC frameless 45 flat 等</td>
                            <td>ベアリング、セットカラーで支持</td>
                        </tr>
                        <tr>
                            <td>駆動/制御</td>
                            <td>モータ駆動と速度制御</td>
                            <td>maxon DECModule 50/5、STM32</td>
                            <td>制御線/I2C接続</td>
                        </tr>
                        <tr>
                            <td>電源</td>
                            <td>システムへの電力供給</td>
                            <td>Effest INR 18350 1200mAh</td>
                            <td>極性・容量に注意</td>
                        </tr>
                        <tr>
                            <td>筐体</td>
                            <td>機構の保持と安全性確保</td>
                            <td>インサートナット、軸ホルダ 等</td>
                            <td>トルク管理/緩み止め</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 回転部（概要常時表示＋詳細折りたたみ） -->
        <section id="rotor" class="structure-item">
            <h2>回転部</h2>
                <p>回転体（フライホイール）、モーター、ベアリング、セットカラーなどで構成されます。偏心やガタの管理が重要です。</p>
                <!-- 画像があればここに追加してください -->
                <!-- <figure class="image"><img src="images/your-image.png" alt="フライホイール回転部"></figure> -->
                <details class="accordion">
                    <summary>
                        <h4>詳細手順・部品票</h4>
                        <p class="summary-text">仮組みから固定、回転体の調整まで。使用部品の一覧も含みます。</p>
                    </summary>
                    <div class="accordion-content">
                        <div class="table-scroll">
                            <table class="excel-table">
                                <thead>
                                    <tr>
                                        <th style="width:72px;">Step</th>
                                        <th>作業内容</th>
                                        <th>参照/備考</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1</td>
                                        <td>ベアリングとセットカラーを所定位置に仮組みする。</td>
                                        <td>圧入/位置決めに注意</td>
                                    </tr>
                                    <tr>
                                        <td>2</td>
                                        <td>モーター（ステータ）を固定し、回り止め用ねじを軽く締める。</td>
                                        <td>トルク管理</td>
                                    </tr>
                                    <tr>
                                        <td>3</td>
                                        <td>低速回転で偏心を確認し、シムリング等で調整する。</td>
                                        <td>異音/振動チェック</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <h5>部品票（フライホイール回転部）</h5>
                        <!-- 動的BOM（Excelから抽出） -->
                        <div class="table-scroll js-bom" data-excel="images/GYRO/Gen2_BOM.xlsx" data-category="回転部|フライホイール回転部"></div>
                        <!-- フォールバック（読み込み失敗時に表示） -->
                        <div class="table-scroll js-fallback" data-category="回転部">
                            <table class="excel-table">
                                <thead>
                                    <tr>
                                        <th>部品名</th>
                                        <th>仕様</th>
                                        <th>型番</th>
                                        <th>材質</th>
                                        <th>表面処理</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>モーター</td>
                                        <td>maxon EC frameless 45 flat 50W</td>
                                        <td>574402</td>
                                        <td>-</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>モータードライバ</td>
                                        <td>maxon DECModule 50/5</td>
                                        <td>380200</td>
                                        <td>-</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>ベアリング</td>
                                        <td>北日本精機</td>
                                        <td>F6700ZZ</td>
                                        <td>-</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>回り止め用ねじ</td>
                                        <td>止めねじ</td>
                                        <td>SSHH-ST-M2.5-10</td>
                                        <td>SCM</td>
                                        <td>黒色酸化被膜</td>
                                    </tr>
                                    <tr>
                                        <td>ステータ固定ねじ</td>
                                        <td>-</td>
                                        <td>SFBJ3-6</td>
                                        <td>SUS304相当</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>軸回り止め用 セットカラー</td>
                                        <td>-</td>
                                        <td>PSCSWJ6-6</td>
                                        <td>S45C</td>
                                        <td>無電解ニッケルメッキ</td>
                                    </tr>
                                    <tr>
                                        <td>軸固定ブッシュ</td>
                                        <td>-</td>
                                        <td>RBKC-D15-V10-T3-L10-C5</td>
                                        <td>クロロプレンゴム(CR)</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>軸ブッシュ固定セットカラー</td>
                                        <td>-</td>
                                        <td>SC0606A</td>
                                        <td>A2017</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>ベアリング固定用シムリング</td>
                                        <td>-</td>
                                        <td>CIMRS10-12-0.5</td>
                                        <td>SUS304H</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>ベアリング固定用セットカラー</td>
                                        <td>-</td>
                                        <td>PSCSJ10-6</td>
                                        <td>S45C相当</td>
                                        <td>無電解ニッケルメッキ</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </details>
        </section>

        <!-- 筐体（概要常時表示＋詳細折りたたみ） -->
        <section id="housing" class="structure-item">
            <h2>筐体</h2>
                <p>インサートナットや軸ホルダなど、回転部を支持し安全性を確保する外装・支持構造です。</p>
                <!-- 画像があればここに追加してください -->
                <!-- <figure class="image"><img src="images/your-image.png" alt="筐体"></figure> -->
                <details class="accordion">
                    <summary>
                        <h4>詳細手順・部品票</h4>
                        <p class="summary-text">インサート圧入から固定まで。使用部品一覧も含みます。</p>
                    </summary>
                    <div class="accordion-content">
                        <div class="table-scroll">
                            <table class="excel-table">
                                <thead>
                                    <tr>
                                        <th style="width:72px;">Step</th>
                                        <th>作業内容</th>
                                        <th>参照/備考</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1</td>
                                        <td>筐体にインサートナットを圧入する。</td>
                                        <td>熱圧入器/半田ごて</td>
                                    </tr>
                                    <tr>
                                        <td>2</td>
                                        <td>軸ホルダを取り付け、ねじを所定トルクで締結する。</td>
                                        <td>緩み止め推奨</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <h5>部品票（筐体）</h5>
                        <!-- 動的BOM（Excelから抽出） -->
                        <div class="table-scroll js-bom" data-excel="images/GYRO/Gen2_BOM.xlsx" data-category="筐体"></div>
                        <!-- フォールバック（読み込み失敗時に表示） -->
                        <div class="table-scroll js-fallback" data-category="筐体">
                            <table class="excel-table">
                                <tbody>
                                    <tr>
                                        <th>ベアリング</th>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <th>ゴムブッシュ</th>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </details>
    </section>

        <section id="first-gen">
            <h2>初代</h2>
            <p>
                高速で回転する円盤を手のひらサイズのキューブに収めた、誰でも楽しめる体験型デバイス。
            </p>
            <figure class="video">
                <video controls src="https://tomohiroaoki.com/wp-content/uploads/2023/05/gyro_small.mp4"></video>
            </figure>
        </section>

        <br>
        <br>

    </div>
    
    <footer>
        <p>&copy; 2025 UGOKU Lab</p>
    </footer>

    <script>
    // TOC: open target section and manage expand/collapse for rotor & housing accordions only
    (function() {
        const toc = document.querySelector('.toc');
        const detailsList = Array.from(document.querySelectorAll('#rotor details.accordion, #housing details.accordion'));

        function openFromHash() {
            const id = decodeURIComponent(location.hash.replace('#',''));
            if (!id) return;
            const target = document.getElementById(id);
            if (target && target.tagName.toLowerCase() === 'details') {
                target.open = true;
                // scroll after open to ensure correct position
                setTimeout(() => target.scrollIntoView({behavior: 'smooth', block: 'start'}), 0);
            } else if (target) {
                const parentDetails = target.closest('details');
                if (parentDetails) parentDetails.open = true;
                setTimeout(() => target.scrollIntoView({behavior: 'smooth', block: 'start'}), 0);
            }
        }

        if (toc) {
            toc.addEventListener('click', (e) => {
                const a = e.target.closest('a');
                if (a && a.getAttribute('href')?.startsWith('#')) {
                    e.preventDefault();
                    const id = a.getAttribute('href').slice(1);
                    const d = document.getElementById(id);
                    if (d && d.tagName.toLowerCase() === 'details') d.open = true;
                    history.pushState(null, '', '#' + id);
                    openFromHash();
                }
                const btn = e.target.closest('.toc-btn');
                if (btn) {
                    const act = btn.dataset.action;
                    detailsList.forEach(d => d.open = (act === 'expand'));
                }
            });
        }
        window.addEventListener('hashchange', openFromHash);
        // open on initial load if hash exists
        if (location.hash) openFromHash();
    })();
    </script>

    <script>
    // Excel BOM loader: fetch and render categorized tables using SheetJS
    (function() {
    const targets = Array.from(document.querySelectorAll('.js-bom[data-excel][data-category]'));
        if (!targets.length) return;
    const debugMode = new URLSearchParams(location.search).has('bomdebug');

        // Load SheetJS dynamically
        function loadSheetJS() {
            return new Promise((resolve, reject) => {
                if (window.XLSX) return resolve();
                const s = document.createElement('script');
                s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
                s.onload = () => resolve();
                s.onerror = () => reject(new Error('SheetJSの読み込みに失敗'));
                document.head.appendChild(s);
            });
        }

        async function fetchRows(url, elForDebug) {
            const res = await fetch(url, { cache: 'no-store' });
            if (debugMode && elForDebug) {
                const ct = res.headers.get('content-type') || '';
                const info = document.createElement('div');
                info.style.cssText = 'margin:6px 0;font-size:12px;color:#666;';
                info.textContent = `BOM fetch: ${res.status} ${res.statusText} ${ct}`;
                elForDebug.appendChild(info);
            }
            if (!res.ok) throw new Error('BOMファイルの取得に失敗');
            const buf = await res.arrayBuffer();
            const wb = XLSX.read(buf, { type: 'array' });
            const sheet = wb.SheetNames[0];
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheet], { defval: '' });
            return rows;
        }

        function normalize(v) { return (v ?? '').toString().trim(); }

        function detectCategoryKey(rows) {
            const sample = rows[0] || {};
            const keys = Object.keys(sample);
            // 候補: 分類 / カテゴリ / Category
            const candidates = ['分類','カテゴリ','カテゴリー','Category','分類1'];
            return keys.find(k => candidates.some(c => k.toString().includes(c))) || '分類';
        }

        function renderTable(container, rows) {
            if (!rows.length) {
                container.innerHTML = '<div style="padding:8px;color:#666;">該当する部品はありません。</div>';
                return false;
            }
            // Preferred column order; fall back to any present columns
            const preferred = ['部品名','仕様','型番','材質','表面処理','数量','備考'];
            const columns = preferred.filter(c => rows.some(r => c in r));
            const rest = Object.keys(rows[0] || {}).filter(k => !columns.includes(k) && k !== '分類');
            const headers = [...columns, ...rest];

            const thead = '<thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
            const tbody = '<tbody>' + rows.map(r => {
                return '<tr>' + headers.map(h => `<td>${normalize(r[h])}</td>`).join('') + '</tr>';
            }).join('') + '</tbody>';
            container.innerHTML = `<table class="excel-table">${thead}${tbody}</table>`;
            return true;
        }

        function renderErrorWithUpload(el, url) {
            const isWeb = /^https?:/i.test(location.protocol);
            if (isWeb && !debugMode) {
                // On web (non-debug), silently rely on static fallback to avoid confusing users
                el.style.display = 'none';
                const parent = el.parentElement;
                const fallback = parent && parent.querySelector('.js-fallback');
                if (fallback) fallback.style.display = '';
                console.warn('BOM fetch failed on web, showing fallback:', url);
                return;
            }
            // In debug mode on web or local preview: show inline debug + upload
            // Local preview: offer upload UI for convenience
            const msg = document.createElement('div');
            msg.style.padding = '8px';
            msg.style.color = '#c00';
            msg.innerHTML = `BOMを読み込めませんでした。 解決URL: <code style="color:#333;">${url}</code> / <a href="${url}" target="_blank" rel="noopener">直接開く</a><br>ローカルのExcelを選択して表示することもできます。`;
            const controls = document.createElement('div');
            controls.style.marginTop = '6px';
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.style.marginRight = '8px';
            const retry = document.createElement('button');
            retry.textContent = '再試行';
            retry.style.cursor = 'pointer';
            retry.style.padding = '4px 8px';
            controls.appendChild(input);
            controls.appendChild(retry);
            el.innerHTML = '';
            el.appendChild(msg);
            el.appendChild(controls);

            retry.addEventListener('click', () => location.reload());
            input.addEventListener('change', async (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) return;
                try {
                    const buf = await file.arrayBuffer();
                    const wb = XLSX.read(buf, { type: 'array' });
                    const sheet = wb.SheetNames[0];
                    const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheet], { defval: '' });
                    const cats = el.getAttribute('data-category').split('|').map(s => s.trim()).filter(Boolean);
                    const catKey = detectCategoryKey(rows);
                    const filtered = rows.filter(r => cats.includes(normalize(r[catKey])));
                    const ok = renderTable(el, filtered);
                    if (ok) {
                        const parent = el.parentElement;
                        const fallback = parent && parent.querySelector('.js-fallback');
                        if (fallback) fallback.style.display = 'none';
                    }
                } catch (e) {
                    console.warn(e);
                    el.innerHTML = '<div style="padding:8px;color:#c00;">ローカルファイルの読み込みに失敗しました。</div>';
                }
            });
        }

        (async () => {
            try {
                await loadSheetJS();
                // Resolve absolute URLs and group targets by file to avoid multiple fetches
                const byFile = targets.reduce((m, el) => {
                    const raw = el.getAttribute('data-excel');
                    const abs = new URL(raw, location.href).href; // always resolve relative to current page
                    (m[abs] ||= []).push(el);
                    return m;
                }, {});

                for (const [url, els] of Object.entries(byFile)) {
                    let rows;
                    try {
                        // add small debug note of resolved URL
                        if (debugMode) {
                            els.forEach(el => {
                                const note = document.createElement('div');
                                note.style.cssText = 'font-size:12px;color:#888;';
                                note.textContent = `Resolved BOM URL: ${url}`;
                                el.appendChild(note);
                            });
                        }
                        rows = await fetchRows(url, debugMode ? els[0] : undefined);
                    } catch (e) { rows = null; }
                    for (const el of els) {
                        const cats = el.getAttribute('data-category').split('|').map(s => s.trim()).filter(Boolean);
                        if (!rows) { renderErrorWithUpload(el, url); continue; }
                        const catKey = detectCategoryKey(rows);
                        const filtered = rows.filter(r => cats.includes(normalize(r[catKey])));
                        const ok = renderTable(el, filtered);
                        if (ok) {
                            // hide fallback in the same accordion content if present
                            const parent = el.parentElement;
                            const fallback = parent && parent.querySelector('.js-fallback');
                            if (fallback) fallback.style.display = 'none';
                        }
                    }
                }
            } catch (err) {
                // Fail silently; fallbacks remain visible
                console.warn(err);
            }
        })();
    })();
    </script>
</body>
</html>
